#!/usr/bin/env bash
set -euo pipefail

parent_path=$(
	cd "$(dirname "${BASH_SOURCE[0]}")"
	pwd -P
)

pushd "$parent_path/.."

echo "==> Upgrading zsh plugins..."
zsh -ic "antidote update"
echo

echo "==> Upgrade fetchgit references..."
find . -name '*.nix' -type f -exec update-nix-fetchgit {} \;
echo

echo "==> Upgrading OS..."
sudo nixos-rebuild --flake .# switch --upgrade
echo

echo "==> Reapplying secrets"
. update
echo
